<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IDV Assignment 3 — Jiaomei Shi (Charts 6,7,8,9,11)</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  :root{
    --bg:#eef4f4;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#64748b;
    --brand:#2563eb;         /* 蓝 */
    --brand-2:#16a34a;       /* 绿 */
    --brand-3:#9333ea;       /* 紫 */
    --warm:#eab308;          /* 暖黄 */
    --danger:#ef4444;
    --border:rgba(2,6,23,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:32px;
    font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,"PingFang SC","Microsoft YaHei",sans-serif;
    color:var(--ink); background:var(--bg);
  }
  h1{margin:0 0 24px}
  h2{margin:48px 0 16px; font-size:32px}
  .card{
    background:var(--card);
    border-radius:16px;
    box-shadow:0 8px 40px rgba(2,6,23,.06);
    padding:20px;
    overflow:hidden;
  }
  .note-block{margin:16px 0 0; color:var(--muted)}
  .note-block h3{margin:0 0 6px; color:#111827; font-size:18px}
  .kbd{font:600 12px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; background:#f1f5f9; padding:2px 6px; border-radius:6px}
  svg text{user-select:none}
  .tooltip{
    position:fixed; pointer-events:none;
    background:#111827; color:#fff; font-size:12px;
    padding:6px 8px; border-radius:6px; box-shadow:0 4px 16px rgba(0,0,0,.18);
    opacity:0; transform:translateY(4px); transition:opacity .15s, transform .15s;
  }
</style>
</head>
<body>

<h1>IDV Assignment 3 — D3 Replications (Charts 6, 7, 8, 9, 11)</h1>

<!-- Shared tooltip -->
<div id="tip" class="tooltip"></div>

<!-- ===================== Chart 6 ===================== -->
<h2>Chart 6 — Schematic (Transformer-like layout)</h2>
<div id="c6" class="card"></div>
<script>
(function(){
  const boxW=980, boxH=420, m={t:24,r:24,b:24,l:24};
  const svg=d3.select("#c6").append("svg").attr("width",boxW).attr("height",boxH);

  // outer module box
  const mod = svg.append("g").attr("transform","translate(40,120)");
  const modW=760, modH=200;

  mod.append("rect")
    .attr("x",0).attr("y",0).attr("rx",14).attr("ry",14)
    .attr("width",modW).attr("height",modH)
    .attr("fill","#f8fafc").attr("stroke","#94a3b8");

  const layers=[
    {y:34,  text:"Multi-head Masked Self-Attention"},
    {y:92,  text:"Feed Forward Neural Network"},
    {y:150, text:"Decoder-Only Layer"},
  ];

  mod.selectAll(".ll").data(layers).enter().append("g")
    .attr("class","ll")
    .each(function(d){
      d3.select(this).append("rect")
        .attr("x",24).attr("y",d.y-20).attr("width",modW-48).attr("height",42)
        .attr("fill","#fff").attr("stroke","#cbd5e1").attr("stroke-dasharray","8 6")
        .attr("opacity",0)
        .transition().delay(200).duration(900)
        .attr("opacity",1);

      d3.select(this).append("text")
        .attr("x",40).attr("y",d.y+4).text(d.text)
        .attr("fill","#0f172a").attr("font-size",18).attr("opacity",0)
        .transition().delay(300).duration(600).attr("opacity",1);
    });

  // input tokens (bottom)
  const token = (g,x,y,w,h,col)=>g.append("rect").attr("x",x).attr("y",y).attr("width",w).attr("height",h)
      .attr("rx",4).attr("fill",col).attr("opacity",0.85);

  const inp = svg.append("g").attr("transform","translate(100,340)");
  d3.range(12).forEach((i)=> token(inp, i*36, 0, 28, 10, "#cbdcfb"));
  svg.append("text").attr("x",100).attr("y",330).text("Input Sequence").attr("fill","#334155");

  // positional embeddings (small blocks)
  const pos=svg.append("g").attr("transform","translate(120,300)");
  d3.range(3).forEach((i)=>{
    pos.append("rect").attr("x",i*220).attr("y",0).attr("width",54).attr("height",16)
      .attr("fill","#e2e8f0").attr("stroke","#94a3b8").attr("opacity",0)
      .transition().delay(400+i*120).duration(600).attr("opacity",1);
    pos.append("text").attr("x",i*220+24).attr("y",-8).attr("text-anchor","middle").text(i+0)
      .attr("fill","#475569");
  });
  svg.append("text").attr("x",100).attr("y",290).text("Positional Embeddings").attr("fill","#334155");

  // output token embeddings (top)
  const out=svg.append("g").attr("transform","translate(160,70)");
  d3.range(10).forEach(i=>{
    out.append("rect").attr("x",i*32).attr("y",0).attr("width",24).attr("height",10)
      .attr("rx",3).attr("fill","#a5b4fc").attr("opacity",0)
      .transition().delay(650+i*60).duration(400).attr("opacity",1);
  });
  svg.append("text").attr("x",100).attr("y",88).text("Output Token Embeddings").attr("fill","#334155");

  // right classification layers + small bar plot
  const cls = svg.append("g").attr("transform","translate(840,120)");
  const clsBox = cls.append("rect").attr("width",220).attr("height",72).attr("rx",14)
    .attr("fill","#fff").attr("stroke","#94a3b8").attr("opacity",0);
  clsBox.transition().delay(800).duration(600).attr("opacity",1);
  cls.append("text").attr("x",110).attr("y",42).attr("text-anchor","middle")
    .text("Classification Layer").attr("opacity",0)
    .transition().delay(880).duration(500).attr("opacity",1);

  const bars = cls.append("g").attr("transform","translate(-10,-34)");
  [16,28,20,34,22].forEach((h,i)=>{
    bars.append("rect").attr("x",20+i*18).attr("y",34).attr("width",10).attr("height",0)
      .attr("fill", i%2? "#86efac" : "#f0abfc")
      .transition().delay(950+i*80).duration(600).attr("y",34-h).attr("height",h);
  });

  // hover: highlight layer rect + title
  const tip=d3.select("#tip");
  mod.selectAll("rect")
    .on("mousemove", function(_,i){
      d3.select(this).attr("fill","#fff6");
      tip.style("opacity",1).style("transform","translateY(0)")
        .style("left",(d3.event.pageX+12)+"px").style("top",(d3.event.pageY+12)+"px")
        .text("Layer: "+(d3.select(this.nextSibling).text()||""));
    })
    .on("mouseleave", function(){
      d3.select(this).attr("fill","#fff");
      tip.style("opacity",0).style("transform","translateY(4px)");
    });
})();
</script>

<div class="note-block">
  <h3>Notes — Chart 6</h3>
  <p>本图复刻了「Transformer-like」示意图：下方输入序列与位置信息，上方输出 token，中央是模块框，包含三条虚线层（Self-Attention / FFN / Decoder-only），右侧是分类头并配以小型柱图。</p>
  <p>过渡：模块层与标签 <span class="kbd">fade-in</span>，输出 token 从左到右逐步显现，小柱图自下而上增长。</p>
  <p>交互：鼠标移入模块中的任一层，会高亮并在 tooltip 显示层名称。</p>
  <p>技术点：<span class="kbd">rect/text</span> 基元布局；<span class="kbd">transition().delay().duration()</span> 控制显隐与生长；简单 tooltip（绝对定位 div）。</p>
</div>


<!-- ===================== Chart 7 ===================== -->
<h2>Chart 7 — Venn (3 sets)</h2>
<div id="c7" class="card"></div>
<script>
(function(){
  const w=980,h=540, svg=d3.select("#c7").append("svg").attr("width",w).attr("height",h);
  const sets=[
    {id:"Delete",   cx:360, cy:320, r:200, color:"#fecaca"},
    {id:"Replace",  cx:630, cy:300, r:210, color:"#bfdbfe"},
    {id:"Rewrite",  cx:520, cy:500, r:230, color:"#bbf7d0"}
  ];

  const g=svg.append("g");
  const circles=g.selectAll("circle").data(sets).enter().append("circle")
    .attr("cx",d=>d.cx).attr("cy",d=>d.cy).attr("r",0)
    .attr("fill",d=>d.color).attr("stroke","#94a3b8").attr("opacity",0.6);

  // transition: grow from zero radius
  circles.transition().duration(900).attr("r",d=>d.r);

  // labels
  svg.selectAll(".lab").data(sets).enter().append("text")
    .attr("class","lab").attr("x",d=>d.cx).attr("y",d=>d.cy-d.r-10)
    .attr("text-anchor","middle").attr("font-size",24).attr("fill","#1f2937")
    .style("opacity",0).text(d=>d.id)
    .transition().delay(300).duration(600).style("opacity",1);

  // hover interaction: pulse + stronger color
  const tip=d3.select("#tip");
  circles
    .on("mousemove", function(e,d){
      d3.select(this).transition().duration(150).attr("opacity",0.8);
      tip.style("opacity",1).style("transform","translateY(0)")
        .style("left",(e.pageX+12)+"px").style("top",(e.pageY+12)+"px")
        .text(d.id+" — hover to focus");
    })
    .on("mouseleave", function(){
      d3.select(this).transition().duration(150).attr("opacity",0.6);
      tip.style("opacity",0).style("transform","translateY(4px)");
    });

  // Roman numerals in overlap regions (approximate positions to match reference)
  const roman=[
    {t:"I",  x:270, y:420},{t:"II", x:600, y:280},{t:"III",x:870, y:540},
    {t:"IV", x:490, y:380},{t:"V",  x:700, y:360},{t:"VI", x:650, y:470},{t:"VII",x:620, y:410}
  ];
  svg.selectAll(".r").data(roman).enter().append("text")
    .attr("x",d=>d.x).attr("y",d=>d.y).attr("text-anchor","middle")
    .attr("font-family","Georgia,serif").attr("font-size",40).attr("fill","#111827")
    .style("opacity",0).text(d=>d.t)
    .transition().delay(450).duration(600).style("opacity",0.9);
})();
</script>

<div class="note-block">
  <h3>Notes — Chart 7</h3>
  <p>三集合维恩图：Delete / Replace / Rewrite 三个半透明圆，重叠区域用罗马数字标注。半径与相对位置与参考图一致（允许少许偏差）。</p>
  <p>过渡：三圆从半径 0 缓慢放大；标签与罗马数字依次显现。</p>
  <p>交互：鼠标移入某集合时提高不透明度并显示名称 tooltip；移出恢复。</p>
  <p>技术点：手动定位重叠区文字；透明叠色用于表达交集；<span class="kbd">transition()</span> + <span class="kbd">opacity</span> 控制聚焦。</p>
</div>


<!-- ===================== Chart 8 ===================== -->
<h2>Chart 8 — Cross Validation Accuracy (simple bars)</h2>
<div id="c8" class="card"></div>
<script>
(function(){
  const data=[
    {model:"BERT",    acc:74.4, base:64.8},
    {model:"RoBERTa", acc:81.9, base:65.5},
    {model:"BART",    acc:73.1, base:63.5},
  ];
  const w=980,h=420, m={t:26,r:20,b:70,l:60};
  const x=d3.scaleBand().domain(data.map(d=>d.model)).range([m.l,w-m.r]).padding(0.42);
  const y=d3.scaleLinear().domain([0,100]).nice().range([h-m.b,m.t]);

  const svg=d3.select("#c8").append("svg").attr("width",w).attr("height",h);

  // axes
  svg.append("g").attr("transform",`translate(0,${h-m.b})`).call(d3.axisBottom(x))
      .selectAll("text").style("font-size","16px");
  svg.append("g").attr("transform",`translate(${m.l},0)`).call(d3.axisLeft(y).ticks(6));

  // dashed baseline ghosts
  svg.selectAll(".ghost").data(data).enter().append("rect").attr("class","ghost")
    .attr("x",d=>x(d.model)+x.bandwidth()/2-22).attr("width",44)
    .attr("y",d=>y(d.base)).attr("height",d=>y(0)-y(d.base))
    .attr("fill","none").attr("stroke","#d1d5db").attr("stroke-dasharray","8 6").attr("opacity",0.9);

  // main bars with transition from baseline
  const bars = svg.selectAll(".bar").data(data).enter().append("rect").attr("class","bar")
    .attr("x",d=>x(d.model)).attr("width",x.bandwidth())
    .attr("y",y(0)).attr("height",0).attr("fill","#3b82f6");

  bars.transition().delay((_,i)=>200+i*200).duration(900)
    .attr("y",d=>y(d.acc)).attr("height",d=>y(0)-y(d.acc));

  // on hover: brighten + show value
  const tip=d3.select("#tip");
  bars.on("mousemove",(e,d)=>{
      d3.select(e.currentTarget).attr("fill","#2563eb");
      tip.style("opacity",1).style("transform","translateY(0)")
        .style("left",(e.pageX+12)+"px").style("top",(e.pageY+12)+"px")
        .text(`${d.model}: ${d.acc.toFixed(1)}% (baseline ${d.base}%)`);
    })
    .on("mouseleave",e=>{
      d3.select(e.currentTarget).attr("fill","#3b82f6");
      tip.style("opacity",0).style("transform","translateY(4px)");
    });

  // value labels (fade in)
  svg.selectAll(".val").data(data).enter().append("text").attr("class","val")
    .attr("x",d=>x(d.model)+x.bandwidth()/2).attr("y",d=>y(d.acc)-6)
    .attr("text-anchor","middle").attr("fill","#111827").attr("font-weight",600)
    .style("opacity",0).text(d=>d.acc.toFixed(1))
    .transition().delay(900).duration(500).style("opacity",1);
})();
</script>

<div class="note-block">
  <h3>Notes — Chart 8</h3>
  <p>三模型分组柱图，柱体从 baseline 虚线框位置向上长到 accuracy 值，复制了参考图的视觉结构（灰色坐标轴、淡黄色改为蓝色系以增强区分）。</p>
  <p>过渡：每根柱子自下而上生长；数值标签淡入。</p>
  <p>交互：悬停高亮并显示 tooltip（模型、准确率与 baseline）。</p>
  <p>技术点：<span class="kbd">scaleBand/scaleLinear</span>、<span class="kbd">axis</span>、<span class="kbd">transition</span>、<span class="kbd">stroke-dasharray</span> 制作虚线基准框。</p>
</div>


<!-- ===================== Chart 9 ===================== -->
<h2>Chart 9 — Sketch Line (SVG stroke animation)</h2>
<div id="c9" class="card"></div>
<script>
(function(){
  const w=980,h=420, svg=d3.select("#c9").append("svg").attr("width",w).attr("height",h);

  // 使用平滑贝塞尔曲线模拟草图路径（与参考的手绘线风格相近）
  const pathStr="M120,300 C280,150 560,180 720,320 S900,390 920,320";
  const p = svg.append("path").attr("d",pathStr)
    .attr("fill","none").attr("stroke","#9333ea").attr("stroke-width",6).attr("stroke-linecap","round");

  // 路径描边动画
  const L = p.node().getTotalLength();
  p.attr("stroke-dasharray", `${L} ${L}`).attr("stroke-dashoffset", L)
   .transition().duration(1400).ease(d3.easeCubicInOut).attr("stroke-dashoffset", 0);

  // 交互：hover 变宽变色
  p.on("mouseenter",function(){ d3.select(this).transition().duration(150).attr("stroke","#7c3aed").attr("stroke-width",8); })
   .on("mouseleave",function(){ d3.select(this).transition().duration(150).attr("stroke","#9333ea").attr("stroke-width",6); });
})();
</script>

<div class="note-block">
  <h3>Notes — Chart 9</h3>
  <p>用单条贝塞尔曲线近似“线稿”，通过 <span class="kbd">getTotalLength</span> + <span class="kbd">stroke-dasharray</span> 实现“手绘描边”动画。</p>
  <p>交互：鼠标移入线稿时加粗并略微变色，模拟钢笔按压力度变化的视觉。</p>
  <p>技术点：SVG path、<span class="kbd">easeCubicInOut</span> 让绘制节奏更自然。</p>
</div>


<!-- ===================== Chart 11 ===================== -->
<h2>Chart 11 — Two Distributions with Decision Band</h2>
<div id="c11" class="card"></div>
<script>
(function(){
  const w=980,h=460,m={t:24,r:20,b:52,l:56};
  const svg=d3.select("#c11").append("svg").attr("width",w).attr("height",h);
  const x=d3.scaleLinear().domain([-2,5]).range([m.l,w-m.r]);
  const y=d3.scaleLinear().domain([0,0.35]).range([h-m.b,m.t]);

  // axes + grid
  svg.append("g").attr("transform",`translate(0,${h-m.b})`).call(d3.axisBottom(x).ticks(8));
  svg.append("g").attr("transform",`translate(${m.l},0)`).call(d3.axisLeft(y).ticks(6));
  svg.selectAll(".tick line").attr("stroke","#e5e7eb");

  // distributions (Gaussian 近似)
  function gauss(mu,sig){
    return d3.range(-2,5.01,0.03).map(x=>({x, y: 1/(sig*Math.sqrt(2*Math.PI))*Math.exp(-0.5*((x-mu)/sig)**2)}));
  }
  const A=gauss(0.2,0.7), B=gauss(2.0,0.7);
  const line=d3.line().x(d=>x(d.x)).y(d=>y(d.y));

  // shaded decision band
  const t1=0.9, t2=1.4;
  svg.append("rect").attr("x",x(t1)).attr("y",y(0.33)).attr("width",x(t2)-x(t1)).attr("height",y(0)-y(0.33))
    .attr("fill","#94a3af").attr("opacity",.35);

  // draw paths with stroke animation
  function draw(data, color, cls){
    const p=svg.append("path").attr("class",cls).attr("d",line(data)).attr("fill","none")
      .attr("stroke",color).attr("stroke-width",3);
    const L=p.node().getTotalLength();
    p.attr("stroke-dasharray", `${L} ${L}`).attr("stroke-dashoffset", L)
      .transition().duration(1200).ease(d3.easeCubicInOut).attr("stroke-dashoffset",0);
    return p;
  }
  const pA=draw(A,"#f59e0b","A"), pB=draw(B,"#0ea5a4","B");

  // legend + hover to highlight
  const legend=svg.append("g").attr("transform",`translate(${w-280},${m.t+6})`);
  legend.append("line").attr("x1",0).attr("x2",22).attr("y1",0).attr("y2",0).attr("stroke","#f59e0b").attr("stroke-width",4);
  legend.append("text").attr("x",28).attr("y",4).text("p(x, y=0) · v(x)").style("dominant-baseline","middle");
  legend.append("line").attr("x1",0).attr("x2",22).attr("y1",22).attr("y2",22).attr("stroke","#0ea5a4").attr("stroke-width",4);
  legend.append("text").attr("x",28).attr("y",26).text("p(x, y=1) · v(x)").style("dominant-baseline","middle");

  legend.selectAll("line").style("cursor","pointer")
    .on("mouseenter",(_,i)=>{
      const cls=i===0?".A":".B";
      svg.selectAll("path").attr("opacity",0.25);
      svg.selectAll(cls).attr("opacity",1).attr("stroke-width",4);
    })
    .on("mouseleave",()=>{
      svg.selectAll("path").attr("opacity",1).attr("stroke-width",3);
    });

  // vertical guideline + tooltip
  const tip=d3.select("#tip");
  const guide=svg.append("line").attr("y1",m.t).attr("y2",h-m.b).attr("stroke","#94a3b8").attr("opacity",0);
  svg.on("mousemove", (e)=>{
    const mx=d3.pointer(e)[0], xv=d3.format(".2f")(x.invert(mx));
    guide.attr("x1",mx).attr("x2",mx).attr("opacity",0.6);
    tip.style("opacity",1).style("transform","translateY(0)")
      .style("left",(e.pageX+12)+"px").style("top",(e.pageY+12)+"px").text(`x = ${xv}`);
  }).on("mouseleave", ()=>{
    guide.attr("opacity",0); tip.style("opacity",0).style("transform","translateY(4px)");
  });
})();
</script>

<div class="note-block">
  <h3>Notes — Chart 11</h3>
  <p>两条高斯分布曲线（近似），并在 <span class="kbd">[0.9, 1.4]</span> 区间加灰色决策带，贴合参考图中“区分两分布的阈值带”的表达。</p>
  <p>过渡：两条曲线用“描边动画”依次绘制；决策带静态铺底。</p>
  <p>交互：图例悬停高亮对应曲线；移动鼠标显示竖向参考线与 x 值。</p>
  <p>技术点：高斯采样、<span class="kbd">line generator</span>、<span class="kbd">stroke-dasharray</span> 动画、legend hover 聚焦。</p>
</div>

</body>
</html>
